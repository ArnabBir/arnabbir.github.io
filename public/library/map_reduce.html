<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapReduce Internals | Arnab Bir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        // Theme initialization
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#161b22',
                            900: '#0d1117',
                            950: '#010409',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Fira+Code:wght@400;500&display=swap');

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 9999px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }

        /* Syntax Highlighting */
        .kw { color: #ff7b72; } /* keyword */
        .fn { color: #d2a8ff; } /* function */
        .str { color: #a5d6ff; } /* string */
        .com { color: #8b949e; font-style: italic; } /* comment */
        .type { color: #79c0ff; } /* type */
        
        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .node-active { @apply ring-2 ring-amber-500 shadow-amber-500/20; }
        .node-processing { @apply animate-pulse; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-200 transition-colors duration-300 antialiased font-sans selection:bg-amber-500/30">

    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-50 bg-white/80 dark:bg-slate-950/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center shadow-lg">
                    <i class="fas fa-project-diagram text-white text-xs"></i>
                </div>
                <span class="font-bold text-lg tracking-tight">Arnab<span class="text-amber-600 dark:text-amber-500">Bir</span></span>
            </div>
            
            <div class="hidden md:flex items-center gap-8 text-sm font-medium text-slate-600 dark:text-slate-400">
                <a href="#visualizer" class="hover:text-amber-600 dark:hover:text-amber-400 transition-colors">Dataflow</a>
                <a href="#model" class="hover:text-amber-600 dark:hover:text-amber-400 transition-colors">Prog Model</a>
                <a href="#fault-tolerance" class="hover:text-amber-600 dark:hover:text-amber-400 transition-colors">Fault Tolerance</a>
                <a href="#refinements" class="hover:text-amber-600 dark:hover:text-amber-400 transition-colors">Refinements</a>
            </div>

            <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors text-slate-600 dark:text-slate-400">
                <i class="fas fa-sun block dark:hidden"></i>
                <i class="fas fa-moon hidden dark:block"></i>
            </button>
        </div>
    </nav>

    <!-- Hero -->
    <header class="pt-32 pb-20 px-6 text-center">
        <div class="max-w-5xl mx-auto">
            <div class="inline-block px-3 py-1 mb-4 text-xs font-bold tracking-wider text-amber-700 dark:text-amber-400 uppercase bg-amber-100 dark:bg-amber-900/30 rounded-full border border-amber-200 dark:border-amber-800">
                Distributed Systems Series
            </div>
            <h1 class="text-5xl md:text-7xl font-extrabold mb-8 bg-clip-text text-transparent bg-gradient-to-r from-amber-600 to-rose-600 dark:from-amber-400 dark:to-rose-400 tracking-tight">MapReduce</h1>
            <p class="text-xl text-slate-600 dark:text-slate-400 leading-relaxed max-w-3xl mx-auto">
                Simplified data processing on large clusters. Explore the mechanics of <span class="font-bold text-slate-900 dark:text-slate-100">Splits</span>, the magic of the <span class="font-bold text-slate-900 dark:text-slate-100">Shuffle</span>, and automatic <span class="font-bold text-slate-900 dark:text-slate-100">Parallelization</span>.
            </p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 space-y-32 pb-32">
        
        <!-- Interactive Dataflow Visualizer -->
        <section id="visualizer" class="scroll-mt-24">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8">
                <div>
                    <h2 class="text-3xl font-bold mb-2">The MapReduce Dataflow</h2>
                    <p class="text-slate-600 dark:text-slate-400 max-w-xl">
                        Simulating the lifecycle of a job: from Input Splits to the final Reduced Output. Watch how intermediate data is partitioned and shuffled.
                    </p>
                </div>
                <div class="flex gap-2 mt-4 md:mt-0">
                    <button id="btn-next" class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-sm font-bold transition-colors shadow-lg shadow-amber-500/30 flex items-center gap-2 border border-amber-500">
                        Next Phase <i class="fas fa-arrow-right"></i>
                    </button>
                    <button id="btn-reset" class="px-4 py-2 bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700 rounded-lg text-sm font-bold transition-colors border border-slate-300 dark:border-slate-700 text-slate-700 dark:text-slate-300">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
            </div>

            <div class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl border border-slate-200 dark:border-slate-700 rounded-2xl p-8 min-h-[600px] relative overflow-hidden shadow-sm transition-all duration-300">
                
                <!-- Topology Grid -->
                <div class="grid grid-cols-12 grid-rows-6 gap-4 h-[500px] relative z-10">
                    
                    <!-- SVG Topology Background -->
                    <svg class="absolute inset-0 w-full h-full pointer-events-none z-0" xmlns="http://www.w3.org/2000/svg" style="fill: none;">
                        <defs>
                            <marker id="arrow-amber" orient="auto" markerWidth="4" markerHeight="4" refX="2" refY="2">
                                <path d="M0,0 V4 L4,2 Z" class="fill-amber-500/50" />
                            </marker>
                        </defs>
                        
                        <!-- Input -> Map -->
                        <path d="M150,150 C200,150 200,100 280,100" class="stroke-slate-200 dark:stroke-slate-700 stroke-2" fill="none" />
                        <path d="M150,300 C200,300 200,250 280,250" class="stroke-slate-200 dark:stroke-slate-700 stroke-2" fill="none" />
                        <path d="M150,450 C200,450 200,400 280,400" class="stroke-slate-200 dark:stroke-slate-700 stroke-2" fill="none" />

                        <!-- Map -> Reduce (The Shuffle Crossbar) -->
                        <path d="M450,100 C600,100 600,200 800,200" class="stroke-slate-200 dark:stroke-slate-700 stroke-[1] stroke-dasharray-2" fill="none" />
                        <path d="M450,100 C600,100 600,350 800,350" class="stroke-slate-200 dark:stroke-slate-700 stroke-[1] stroke-dasharray-2" fill="none" />
                        
                        <path d="M450,250 C600,250 600,200 800,200" class="stroke-slate-200 dark:stroke-slate-700 stroke-[1] stroke-dasharray-2" fill="none" />
                        <path d="M450,250 C600,250 600,350 800,350" class="stroke-slate-200 dark:stroke-slate-700 stroke-[1] stroke-dasharray-2" fill="none" />

                        <path d="M450,400 C600,400 600,200 800,200" class="stroke-slate-200 dark:stroke-slate-700 stroke-[1] stroke-dasharray-2" fill="none" />
                        <path d="M450,400 C600,400 600,350 800,350" class="stroke-slate-200 dark:stroke-slate-700 stroke-[1] stroke-dasharray-2" fill="none" />

                        <!-- Reduce -> Output -->
                        <path d="M960,200 L1080,200" class="stroke-slate-200 dark:stroke-slate-700 stroke-2" fill="none" />
                        <path d="M960,350 L1080,350" class="stroke-slate-200 dark:stroke-slate-700 stroke-2" fill="none" />
                    </svg>

                    <!-- Input Splits -->
                    <div class="col-start-1 col-span-2 row-span-6 flex flex-col justify-around py-12">
                        <div id="split-0" class="bg-slate-100 dark:bg-slate-800 p-3 rounded border border-slate-300 dark:border-slate-600 text-center text-xs font-mono">Split 0<br>(64MB)</div>
                        <div id="split-1" class="bg-slate-100 dark:bg-slate-800 p-3 rounded border border-slate-300 dark:border-slate-600 text-center text-xs font-mono">Split 1<br>(64MB)</div>
                        <div id="split-2" class="bg-slate-100 dark:bg-slate-800 p-3 rounded border border-slate-300 dark:border-slate-600 text-center text-xs font-mono">Split 2<br>(64MB)</div>
                    </div>

                    <!-- Map Workers -->
                    <div class="col-start-3 col-span-2 row-span-6 flex flex-col justify-around py-8">
                        <div id="worker-map-0" class="bg-white dark:bg-slate-850 p-4 rounded-xl border-2 border-amber-500 text-center shadow-lg relative transition-all">
                            <i class="fas fa-cogs text-amber-500 mb-2"></i>
                            <div class="text-xs font-bold">Map Worker 1</div>
                            <div class="buffer-files absolute -right-6 top-2 hidden space-y-1">
                                <div class="w-4 h-4 bg-rose-500 rounded text-[8px] flex items-center justify-center text-white">R1</div>
                                <div class="w-4 h-4 bg-indigo-500 rounded text-[8px] flex items-center justify-center text-white">R2</div>
                            </div>
                        </div>
                        <div id="worker-map-1" class="bg-white dark:bg-slate-850 p-4 rounded-xl border-2 border-amber-500 text-center shadow-lg relative transition-all">
                            <i class="fas fa-cogs text-amber-500 mb-2"></i>
                            <div class="text-xs font-bold">Map Worker 2</div>
                            <div class="buffer-files absolute -right-6 top-2 hidden space-y-1">
                                <div class="w-4 h-4 bg-rose-500 rounded text-[8px] flex items-center justify-center text-white">R1</div>
                                <div class="w-4 h-4 bg-indigo-500 rounded text-[8px] flex items-center justify-center text-white">R2</div>
                            </div>
                        </div>
                        <div id="worker-map-2" class="bg-white dark:bg-slate-850 p-4 rounded-xl border-2 border-amber-500 text-center shadow-lg relative transition-all">
                            <i class="fas fa-cogs text-amber-500 mb-2"></i>
                            <div class="text-xs font-bold">Map Worker 3</div>
                            <div class="buffer-files absolute -right-6 top-2 hidden space-y-1">
                                <div class="w-4 h-4 bg-rose-500 rounded text-[8px] flex items-center justify-center text-white">R1</div>
                                <div class="w-4 h-4 bg-indigo-500 rounded text-[8px] flex items-center justify-center text-white">R2</div>
                            </div>
                        </div>
                    </div>

                    <!-- Shuffle Zone -->
                    <div class="col-start-6 col-span-2 row-span-6 flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-random text-slate-300 dark:text-slate-600 text-4xl mb-2"></i>
                            <div class="text-xs text-slate-400 uppercase tracking-widest font-bold">Shuffle</div>
                        </div>
                    </div>

                    <!-- Reduce Workers -->
                    <div class="col-start-9 col-span-2 row-span-6 flex flex-col justify-center gap-24 py-12">
                        <div id="worker-red-0" class="bg-white dark:bg-slate-850 p-4 rounded-xl border-2 border-rose-500 text-center shadow-lg relative transition-all">
                            <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-rose-500 text-white text-[10px] px-2 rounded-full">Part 0</div>
                            <i class="fas fa-compress-arrows-alt text-rose-500 mb-2"></i>
                            <div class="text-xs font-bold">Reduce Worker 1</div>
                        </div>
                        <div id="worker-red-1" class="bg-white dark:bg-slate-850 p-4 rounded-xl border-2 border-indigo-500 text-center shadow-lg relative transition-all">
                            <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-indigo-500 text-white text-[10px] px-2 rounded-full">Part 1</div>
                            <i class="fas fa-compress-arrows-alt text-indigo-500 mb-2"></i>
                            <div class="text-xs font-bold">Reduce Worker 2</div>
                        </div>
                    </div>

                    <!-- Output Files -->
                    <div class="col-start-12 col-span-1 row-span-6 flex flex-col justify-center gap-24 py-12">
                         <div id="out-0" class="bg-slate-100 dark:bg-slate-800 p-3 rounded border border-slate-300 dark:border-slate-600 text-center text-xs font-mono opacity-50">part-0</div>
                         <div id="out-1" class="bg-slate-100 dark:bg-slate-800 p-3 rounded border border-slate-300 dark:border-slate-600 text-center text-xs font-mono opacity-50">part-1</div>
                    </div>

                    <!-- Dynamic Packets -->
                    <div id="packet-container" class="absolute inset-0 pointer-events-none overflow-hidden"></div>

                </div>

                <!-- Explanation Panel -->
                <div class="absolute bottom-0 left-0 w-full bg-slate-50/95 dark:bg-slate-900/95 backdrop-blur-md p-6 border-t border-slate-200 dark:border-slate-800 transition-transform duration-500 z-30">
                    <div class="flex items-start gap-4">
                        <div id="step-number" class="w-8 h-8 rounded-full bg-slate-800 dark:bg-slate-700 text-white flex items-center justify-center font-bold text-sm shrink-0 shadow-inner">0</div>
                        <div>
                            <h4 id="step-title" class="font-bold text-lg mb-1 text-slate-900 dark:text-white">Job Initialization</h4>
                            <p id="step-desc" class="text-slate-600 dark:text-slate-400 text-sm font-mono leading-relaxed">
                                The Master partitions input files into M splits (typically 16-64MB). Click 'Next Phase' to assign Map tasks.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Programming Model -->
        <section id="model" class="scroll-mt-24">
            <h2 class="text-3xl font-bold mb-12 flex items-center gap-3">
                <span class="text-amber-600 dark:text-amber-500">01.</span> The Programming Model
            </h2>
            <div class="grid lg:grid-cols-2 gap-12">
                <div>
                    <p class="text-slate-600 dark:text-slate-400 mb-6 text-lg leading-relaxed">
                        MapReduce allows programmers to process huge datasets using a functional style. The library handles the messy details of parallelization, fault tolerance, locality optimization, and load balancing.
                    </p>
                    <div class="space-y-6">
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border-l-4 border-amber-500 shadow-sm">
                            <h4 class="font-bold text-slate-900 dark:text-white mb-2 font-mono">Map (k1, v1) → list(k2, v2)</h4>
                            <p class="text-sm text-slate-600 dark:text-slate-400">
                                Takes an input pair and produces a set of intermediate key/value pairs. The library groups together all intermediate values associated with the same intermediate key <code>I</code>.
                            </p>
                        </div>
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border-l-4 border-rose-500 shadow-sm">
                            <h4 class="font-bold text-slate-900 dark:text-white mb-2 font-mono">Reduce (k2, list(v2)) → list(v2)</h4>
                            <p class="text-sm text-slate-600 dark:text-slate-400">
                                Accepts an intermediate key and a set of values for that key. Merges these values to form a possibly smaller set of values (e.g., a sum).
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="code-block bg-slate-950 text-slate-300 rounded-lg p-6 shadow-inner border border-slate-800 font-mono text-sm overflow-x-auto">
<span class="com">// Word Count Example</span>
<br/>
<span class="kw">map</span>(<span class="type">String</span> key, <span class="type">String</span> value):<br/>
&nbsp;&nbsp;<span class="com">// key: document name</span><br/>
&nbsp;&nbsp;<span class="com">// value: document contents</span><br/>
&nbsp;&nbsp;<span class="kw">for each</span> word w <span class="kw">in</span> value:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="fn">EmitIntermediate</span>(w, <span class="str">"1"</span>);<br/>
<br/>
<span class="kw">reduce</span>(<span class="type">String</span> key, <span class="type">Iterator</span> values):<br/>
&nbsp;&nbsp;<span class="com">// key: a word</span><br/>
&nbsp;&nbsp;<span class="com">// values: a list of counts</span><br/>
&nbsp;&nbsp;<span class="type">int</span> result = 0;<br/>
&nbsp;&nbsp;<span class="kw">for each</span> v <span class="kw">in</span> values:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;result += <span class="fn">ParseInt</span>(v);<br/>
&nbsp;&nbsp;<span class="fn">Emit</span>(<span class="fn">AsString</span>(result));
                </div>
            </div>
        </section>

        <!-- Fault Tolerance & Locality -->
        <section id="fault-tolerance" class="scroll-mt-24">
            <h2 class="text-3xl font-bold mb-12 flex items-center gap-3">
                <span class="text-amber-600 dark:text-amber-500">02.</span> Fault Tolerance & Locality
            </h2>
            
            <div class="grid md:grid-cols-3 gap-8">
                <!-- Map Failure -->
                <div class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl border border-slate-200 dark:border-slate-700 p-8 rounded-2xl shadow-sm transition-all duration-300 hover:border-amber-500/50">
                    <div class="w-12 h-12 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center text-amber-600 dark:text-amber-400 mb-4">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-4">Worker Failure (Map)</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
                        Completed Map tasks are <strong>re-executed</strong> on failure because their output is stored on the <strong>local disk</strong> of the failed machine and is therefore inaccessible.
                    </p>
                </div>

                <!-- Reduce Failure -->
                <div class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl border border-slate-200 dark:border-slate-700 p-8 rounded-2xl shadow-sm transition-all duration-300 hover:border-rose-500/50">
                    <div class="w-12 h-12 bg-rose-100 dark:bg-rose-900/30 rounded-full flex items-center justify-center text-rose-600 dark:text-rose-400 mb-4">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-4">Worker Failure (Reduce)</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
                        Completed Reduce tasks <strong>do not</strong> need to be re-executed. Their output is stored in the global file system (GFS), which provides reliability through replication.
                    </p>
                </div>

                <!-- Locality -->
                <div class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl border border-slate-200 dark:border-slate-700 p-8 rounded-2xl shadow-sm transition-all duration-300 hover:border-sky-500/50">
                    <div class="w-12 h-12 bg-sky-100 dark:bg-sky-900/30 rounded-full flex items-center justify-center text-sky-600 dark:text-sky-400 mb-4">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-4">Locality Optimization</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
                        The Master schedules Map tasks on machines that contain the input data (GFS blocks). This conserves network bandwidth, which is a scarce resource in the cluster.
                    </p>
                </div>
            </div>
            
            <!-- Refinements Section -->
            <div id="refinements" class="mt-16 bg-slate-950 rounded-2xl p-8 border border-slate-800 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-amber-500/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                
                <h3 class="text-2xl font-bold text-white mb-6">Execution Refinements</h3>
                <div class="grid md:grid-cols-2 gap-8 relative z-10">
                    <div>
                        <h4 class="text-amber-400 font-bold mb-2 text-sm uppercase tracking-wider">Combiner Function</h4>
                        <p class="text-slate-400 text-sm mb-4">
                            Significant repetition in intermediate keys (e.g., word counts) causes network congestion. A <strong>Combiner</strong> function does partial merging on the map worker before sending data over the network.
                        </p>
                        <code class="text-xs bg-slate-900 p-2 rounded text-slate-300 block border border-slate-800">map_out: <"the",1>, <"the",1> -> combiner -> net_out: <"the",2></code>
                    </div>
                    <div>
                        <h4 class="text-amber-400 font-bold mb-2 text-sm uppercase tracking-wider">Backup Tasks</h4>
                        <p class="text-slate-400 text-sm mb-4">
                            "Stragglers" (slow machines) can delay job completion. When a job is close to finishing, the Master schedules <strong>backup executions</strong> of remaining tasks. The task completes when either the primary or backup finishes.
                        </p>
                        <p class="text-xs text-slate-500 italic">Example: Sort takes 44% longer without backup tasks.</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-white dark:bg-slate-950 py-20 px-6 border-t border-slate-200 dark:border-slate-800">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-8">
            <div class="text-center md:text-left">
                <p class="font-bold text-xl mb-2 text-slate-900 dark:text-white">Arnab Bir</p>
                <p class="text-slate-500 text-sm">Exploring the depths of distributed engineering.</p>
            </div>
            <div class="flex gap-6">
                <a href="#" class="text-slate-400 hover:text-amber-600 dark:hover:text-amber-400 transition-colors"><i class="fab fa-github text-xl"></i></a>
                <a href="#" class="text-slate-400 hover:text-amber-600 dark:hover:text-amber-400 transition-colors"><i class="fab fa-linkedin text-xl"></i></a>
                <a href="#" class="text-slate-400 hover:text-amber-600 dark:hover:text-amber-400 transition-colors"><i class="fas fa-envelope text-xl"></i></a>
            </div>
        </div>
    </footer>

    <script>
        // --- THEME ---
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // --- VISUALIZER LOGIC ---
        const steps = [
            {
                title: "1. Map Phase (Execution)",
                desc: "Map workers read split data, parse key/values, and pass them to the user Map function. Intermediate pairs are buffered in memory.",
                action: (viz) => {
                    viz.highlight(['worker-map-0', 'worker-map-1', 'worker-map-2']);
                    viz.animateProcessing(['worker-map-0', 'worker-map-1', 'worker-map-2']);
                }
            },
            {
                title: "2. Spill to Disk (Partitioning)",
                desc: "Buffered pairs are periodically written to local disk, partitioned into R regions (R=2 here).",
                action: (viz) => {
                    document.querySelectorAll('.buffer-files').forEach(el => el.classList.remove('hidden'));
                }
            },
            {
                title: "3. Shuffle Phase",
                desc: "Reduce workers use RPCs to read buffered data from the local disks of map workers. Data is sorted by key.",
                action: (viz) => {
                    // Stop map processing animation
                    viz.stopProcessing();
                    
                    // Create packets from Maps to Reduces
                    // R1 (Rose) goes to Reduce Worker 1
                    // R2 (Indigo) goes to Reduce Worker 2
                    
                    // From Map 1
                    viz.spawnPacket('worker-map-0', 'worker-red-0', 'bg-rose-500');
                    setTimeout(() => viz.spawnPacket('worker-map-0', 'worker-red-1', 'bg-indigo-500'), 200);
                    
                    // From Map 2
                    setTimeout(() => {
                        viz.spawnPacket('worker-map-1', 'worker-red-0', 'bg-rose-500');
                        setTimeout(() => viz.spawnPacket('worker-map-1', 'worker-red-1', 'bg-indigo-500'), 200);
                    }, 500);

                    // From Map 3
                    setTimeout(() => {
                        viz.spawnPacket('worker-map-2', 'worker-red-0', 'bg-rose-500');
                        setTimeout(() => viz.spawnPacket('worker-map-2', 'worker-red-1', 'bg-indigo-500'), 200);
                    }, 1000);
                }
            },
            {
                title: "4. Reduce Phase",
                desc: "Reduce workers iterate over sorted intermediate data. For each unique key, the Reduce function is called.",
                action: (viz) => {
                     viz.highlight(['worker-red-0', 'worker-red-1']);
                     viz.animateProcessing(['worker-red-0', 'worker-red-1']);
                }
            },
            {
                title: "5. Output Generation",
                desc: "The output of the Reduce function is appended to a final output file in GFS.",
                action: (viz) => {
                    viz.stopProcessing();
                    document.getElementById('out-0').classList.remove('opacity-50');
                    document.getElementById('out-0').classList.add('bg-rose-100', 'dark:bg-rose-900', 'border-rose-500');
                    
                    document.getElementById('out-1').classList.remove('opacity-50');
                    document.getElementById('out-1').classList.add('bg-indigo-100', 'dark:bg-indigo-900', 'border-indigo-500');
                }
            }
        ];

        class Visualizer {
            constructor() {
                this.stepIndex = -1;
                this.btnNext = document.getElementById('btn-next');
                this.btnReset = document.getElementById('btn-reset');
                
                this.btnNext.addEventListener('click', () => this.next());
                this.btnReset.addEventListener('click', () => this.reset());
            }

            reset() {
                this.stepIndex = -1;
                this.updateText("Job Initialization", "The Master partitions input files into M splits (typically 16-64MB). Click 'Next Phase' to assign Map tasks.");
                
                // Clear all visual states
                document.querySelectorAll('.node-active').forEach(el => el.classList.remove('node-active'));
                document.querySelectorAll('.node-processing').forEach(el => el.classList.remove('node-processing'));
                document.querySelectorAll('.buffer-files').forEach(el => el.classList.add('hidden'));
                
                const out0 = document.getElementById('out-0');
                const out1 = document.getElementById('out-1');
                out0.classList.add('opacity-50');
                out0.classList.remove('bg-rose-100', 'dark:bg-rose-900', 'border-rose-500');
                out1.classList.add('opacity-50');
                out1.classList.remove('bg-indigo-100', 'dark:bg-indigo-900', 'border-indigo-500');
                
                document.getElementById('step-number').innerText = '0';
            }

            next() {
                this.stepIndex++;
                if (this.stepIndex >= steps.length) {
                    this.reset();
                    return;
                }
                const step = steps[this.stepIndex];
                this.updateText(step.title, step.desc, this.stepIndex + 1);
                step.action(this);
            }

            updateText(title, desc, num = 0) {
                document.getElementById('step-title').innerText = title;
                document.getElementById('step-desc').innerText = desc;
                document.getElementById('step-number').innerText = num;
            }

            highlight(ids) {
                ids.forEach(id => document.getElementById(id).classList.add('node-active'));
            }

            animateProcessing(ids) {
                ids.forEach(id => document.getElementById(id).classList.add('node-processing'));
            }

            stopProcessing() {
                 document.querySelectorAll('.node-processing').forEach(el => el.classList.remove('node-processing'));
                 document.querySelectorAll('.node-active').forEach(el => el.classList.remove('node-active'));
            }

            spawnPacket(fromId, toId, colorClass) {
                const container = document.getElementById('packet-container');
                const fromEl = document.getElementById(fromId);
                const toEl = document.getElementById(toId);
                
                const startRect = fromEl.getBoundingClientRect();
                const endRect = toEl.getBoundingClientRect();
                const parentRect = container.getBoundingClientRect();

                const startX = startRect.left - parentRect.left + startRect.width / 2;
                const startY = startRect.top - parentRect.top + startRect.height / 2;
                
                const endX = endRect.left - parentRect.left + endRect.width / 2;
                const endY = endRect.top - parentRect.top + endRect.height / 2;

                const packet = document.createElement('div');
                packet.className = `absolute w-4 h-4 rounded-full ${colorClass} shadow-md z-50 transition-all ease-in-out`;
                packet.style.left = `${startX}px`;
                packet.style.top = `${startY}px`;
                packet.style.transitionDuration = '1.5s'; // Slower Shuffle
                
                container.appendChild(packet);

                // Force reflow
                void packet.offsetWidth;

                packet.style.left = `${endX}px`;
                packet.style.top = `${endY}px`;

                setTimeout(() => {
                    packet.remove();
                }, 1500);
            }
        }

        new Visualizer();
    </script>
</body>
</html>