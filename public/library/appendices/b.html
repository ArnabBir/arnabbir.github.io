<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TLPI v2 — Appendix B — Parsing Command-Line Options</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&family=JetBrains+Mono:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/theme.css"/>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo"></div>
        <div style="min-width:0">
          <h1>TLPI Interactive Library <span class="muted2">v2</span></h1>
          <div class="sub" id="subTitle">Appendix B — Parsing Command-Line Options</div>
        </div>
      </div>
      <div class="actions">
        <span class="pill"><strong data-theme-badge>Dark</strong><span class="muted2">•</span><span class="muted">Theme</span></span>
        <button class="btn small" data-theme-toggle>Toggle</button>
        <a class="btn small ghost" href="../index.html">Index</a>
        <a class="btn small" data-prev disabled href="#" title="Previous (Ctrl/⌘+←)">Prev</a>
        <a class="btn small primary" data-next disabled href="#" title="Next (Ctrl/⌘+→)">Next</a>
      </div>
    </div>
    <div class="progress" id="scrollProgress"></div>
  </header>

  <div class="layout">
    <div class="shell">
      <aside class="sidebar">
        <div class="glass pad">
          <div class="section-title">Chapters</div>
          <input class="input" id="navSearch" placeholder="Search (press /)…"/>
          <div id="navList" class="navlist"></div>
        </div>

        <div class="glass pad" style="margin-top:12px">
          <div class="section-title">Appendix metadata</div>
          <div class="muted2 small" style="margin-top:8px">Reference: TLPI PDF page index <span class="mono">1449</span> (0-based index 1448).</div>
          <div class="muted2 small" style="margin-top:8px">Theme: <span class="pill"><strong>intro</strong></span></div>
          <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px"><span class="pill"><strong>standards</strong></span> <span class="pill"><strong>POSIX</strong></span> <span class="pill"><strong>errno</strong></span> <span class="pill"><strong>man pages</strong></span></div>
          <hr class="sep"/>
          <div class="muted2 small">Keyboard:</div>
          <div class="muted small" style="margin-top:6px">
            <span class="pill"><span class="mono">/</span> search</span>
            <span class="pill"><span class="mono">Ctrl/⌘ + ←/→</span> nav</span>
          </div>
        </div>
      </aside>

      <main>
        <div class="glass hero">
          <h2 style="background:linear-gradient(90deg, rgba(124,58,237,.92), rgba(6,182,212,.86)); -webkit-background-clip:text; background-clip:text; color:transparent">
            Appendix B — Parsing Command-Line Options
          </h2>
          <div class="subtitle"><p>Command-line parsing is deceptively tricky in C: you must handle short/long options, option arguments, repeated flags, and the boundary between options and positional arguments — all while producing correct error messages.</p><p>This appendix is about robust, predictable parsing using getopt-style APIs and about designing CLIs that remain stable as you add options over time.</p></div>
          <div class="callouts"><div class="callout good">
  <div class="k">Invariant</div>
  <div class="v">Syscalls expose kernel objects; libc wraps them and sets errno on failure.</div>
</div><div class="callout warn">
  <div class="k">Gotcha</div>
  <div class="v">Man pages have details in NOTES/CAVEATS that are easy to miss.</div>
</div><div class="callout tip">
  <div class="k">Debugging</div>
  <div class="v">Use strace early; it quickly reveals the kernel boundary and errors.</div>
</div></div>
        </div>

        <div class="glass pad-lg">
          <h3 class="section" data-toc="Key concepts">Key concepts</h3>
          <div class="muted" style="margin-top:-4px; margin-bottom:12px">
            Use these as a cross-chapter index: the same kernel objects reappear everywhere.
          </div>
          <table class="table">
  <thead><tr><th>Term / object</th><th>Meaning</th></tr></thead>
  <tbody><tr><td class='mono'>Syscall</td><td>Kernel entry point providing OS services; invoked via libc wrappers.</td></tr><tr><td class='mono'>Libc wrapper</td><td>User-space function that prepares arguments and invokes syscall; may add compatibility logic.</td></tr><tr><td class='mono'>POSIX</td><td>Standard defining portable APIs and behavior; Linux adds extensions.</td></tr><tr><td class='mono'>Man pages</td><td>Primary interface documentation; section 2=syscalls, 3=libc.</td></tr><tr><td class='mono'>errno</td><td>Error reporting mechanism for many syscalls and libc calls.</td></tr><tr><td class='mono'>UAPI</td><td>User-space API headers defining kernel interfaces.</td></tr></tbody>
</table>
        </div>

        <div class="glass pad-lg">
  <h3 class="section" data-toc="Interactive labs">Interactive labs</h3>
  <div class="muted" style="margin-top:-4px; margin-bottom:12px">
    Appendices are practice-oriented: use these widgets to reinforce core mechanics and debugging posture.
  </div>
  <div id="kg_appB"></div>
<div id="str_appB"></div>
</div>

        <div class="glass pad-lg" style="margin-top:12px">
          <h3 class="section" data-toc="Deep dive">Deep dive</h3>
          <div class="muted" style="margin-top:-4px; margin-bottom:12px">
            Practical panels: tools, workflows, and invariants worth memorizing.
          </div>
          <details class="accordion">
  <summary>getopt basics</summary>
  <div class="content"><ul><li>getopt() parses short options like -v or -o VALUE.</li><li>optind indexes the next argv element to process; after parsing, argv+optind are positional args.</li><li>A leading &#x27;:&#x27; in the option string changes how errors are reported (missing arg).</li><li>Use &#x27;--&#x27; to end option parsing explicitly (so positional args starting with &#x27;-&#x27; work).</li></ul></div>
</details><details class="accordion">
  <summary>Long options (getopt_long)</summary>
  <div class="content"><ul><li>getopt_long() adds GNU-style --option and --option=value forms.</li><li>Design long options for stability: avoid renaming options in compatible CLIs.</li><li>Define clear semantics for repeated options (override vs accumulate).</li><li>Keep parsing separate from validation: parse first, then validate invariants.</li></ul></div>
</details><details class="accordion">
  <summary>Common pitfalls</summary>
  <div class="content"><ul><li>Mixing option parsing with side effects (opening files) complicates error handling; parse first.</li><li>Not resetting global getopt state when parsing multiple times in one process (e.g., tests).</li><li>Assuming argv strings are trusted; for privileged programs, treat argv/env as untrusted inputs.</li><li>Inconsistent error messages make automation brittle; keep them machine-parseable if needed.</li></ul></div>
</details>
        </div>

        <div class="glass pad-lg" style="margin-top:12px">
          <h3 class="section" data-toc="API quick reference">API quick reference</h3>
          <div class="muted" style="margin-top:-4px; margin-bottom:12px">
            APIs you’ll likely use while working through these topics.
          </div>
          <table class="table">
  <thead>
    <tr>
      <th>API</th>
      <th>Signature / shape</th>
      <th>Common errno</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr><td class='mono'>open</td><td class='mono'>int open(const char *path, int flags, mode_t mode /* optional */);</td><td class='mono muted2'>ENOENT, EACCES, EISDIR, EMFILE, ENFILE, ENOSPC</td><td>Prefer openat() for race-resistant path handling; set O_CLOEXEC by default.</td></tr><tr><td class='mono'>openat</td><td class='mono'>int openat(int dirfd, const char *path, int flags, mode_t mode /* optional */);</td><td class='mono muted2'>ENOENT, EACCES, ENOTDIR, EMFILE, ENFILE</td><td>Compose with *at() family to avoid TOCTOU. Use AT_FDCWD for CWD.</td></tr><tr><td class='mono'>perror</td><td class='mono'>void perror(const char *s);</td><td class='mono muted2'>—</td><td>Prints s + error message for current errno to stderr.</td></tr><tr><td class='mono'>errno</td><td class='mono'>extern int errno; (thread-local)</td><td class='mono muted2'>—</td><td>Thread-local error indicator set by failing syscalls/libc wrappers; read immediately after failure.</td></tr>
  </tbody>
</table>
        </div>

        <div class="glass pad-lg" style="margin-top:12px">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
            <h3 class="section" data-toc="Code patterns">Code patterns</h3>
            <button class="btn small" data-copy="#code_appB">Copy</button>
          </div>
          <div class="muted" style="margin-top:-4px; margin-bottom:12px">
            Appendix snippets emphasize workflow and instrumentation.
          </div>
          <pre id="code_appB"><code class="mono">// Minimal getopt_long example (outline)
#include &lt;getopt.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main(int argc, char **argv){
  int verbose = 0;
  const char *out = NULL;

  static struct option long_opts[] = {
    {&quot;verbose&quot;, no_argument,       0, &#x27;v&#x27;},
    {&quot;output&quot;,  required_argument, 0, &#x27;o&#x27;},
    {0,0,0,0}
  };

  for(;;){
    int c = getopt_long(argc, argv, &quot;vo:&quot;, long_opts, NULL);
    if(c == -1) break;
    switch(c){
      case &#x27;v&#x27;: verbose++; break;
      case &#x27;o&#x27;: out = optarg; break;
      default:
        fprintf(stderr, &quot;usage: %s [-v] [-o FILE] [--] args...\n&quot;, argv[0]);
        return 2;
    }
  }

  // Positional arguments start at argv[optind]
  for(int i=optind; i&lt;argc; i++){
    if(verbose) fprintf(stderr, &quot;arg: %s\n&quot;, argv[i]);
  }
  if(out) fprintf(stderr, &quot;output=%s\n&quot;, out);
  return 0;
}</code></pre>
        </div>

        <div class="glass pad-lg" style="margin-top:12px">
          <h3 class="section" data-toc="Production checklist">Production checklist</h3>
          <div class="muted" style="margin-top:-4px; margin-bottom:12px">
            Checklists are how you stop repeating incidents.
          </div>
          <div class="prose"><ul><li>Always read the ERRORS section of man pages and treat it as part of your API contract.</li><li>Write minimal experiments to confirm assumptions; keep strace/perf in your toolbox.</li><li>Separate portability layer from Linux-specific optimizations.</li><li>Make error messages actionable: include inputs and context.</li><li>Prefer simple, explicit invariants over clever code.</li></ul></div>
        </div>

        <div class="glass pad-lg" style="margin-top:12px">
          <h3 class="section" data-toc="Quiz">Quiz</h3>
          <div class="muted" style="margin-top:-4px; margin-bottom:12px">Quick self-check.</div>
          <div class="quiz"><div class="q" data-quiz data-answer="1" data-explain="optind points to the next argv index; after parsing it is the first non-option argument.">
  <div class="qp">Q1. What does optind represent after getopt parsing?</div>
  <div class="opts"><div class="opt" data-opt="0">
  <div class="dot"></div>
  <div><div style="font-weight:750">Number of options</div></div>
</div><div class="opt" data-opt="1">
  <div class="dot"></div>
  <div><div style="font-weight:750">Index of first positional argument</div></div>
</div><div class="opt" data-opt="2">
  <div class="dot"></div>
  <div><div style="font-weight:750">PID of process</div></div>
</div><div class="opt" data-opt="3">
  <div class="dot"></div>
  <div><div style="font-weight:750">File descriptor</div></div>
</div></div>
  <div class="feedback muted2 small"></div>
</div><div class="q" data-quiz data-answer="1" data-explain="&#x27;--&#x27; ends option parsing for getopt-style parsers.">
  <div class="qp">Q2. How do you stop option parsing when positional args start with &#x27;-&#x27;?</div>
  <div class="opts"><div class="opt" data-opt="0">
  <div class="dot"></div>
  <div><div style="font-weight:750">Use &#x27;-&#x27;</div></div>
</div><div class="opt" data-opt="1">
  <div class="dot"></div>
  <div><div style="font-weight:750">Use &#x27;--&#x27;</div></div>
</div><div class="opt" data-opt="2">
  <div class="dot"></div>
  <div><div style="font-weight:750">Use &#x27;::&#x27;</div></div>
</div><div class="opt" data-opt="3">
  <div class="dot"></div>
  <div><div style="font-weight:750">You can&#x27;t</div></div>
</div></div>
  <div class="feedback muted2 small"></div>
</div><div class="q" data-quiz data-answer="1" data-explain="Separating parse and validate simplifies error handling and keeps behavior predictable.">
  <div class="qp">Q3. A good CLI parsing practice is:</div>
  <div class="opts"><div class="opt" data-opt="0">
  <div class="dot"></div>
  <div><div style="font-weight:750">Do side effects during parsing</div></div>
</div><div class="opt" data-opt="1">
  <div class="dot"></div>
  <div><div style="font-weight:750">Parse first, validate second</div></div>
</div><div class="opt" data-opt="2">
  <div class="dot"></div>
  <div><div style="font-weight:750">Ignore errors</div></div>
</div><div class="opt" data-opt="3">
  <div class="dot"></div>
  <div><div style="font-weight:750">Use global variables everywhere</div></div>
</div></div>
  <div class="feedback muted2 small"></div>
</div></div>
        </div>

        <div class="glass pad" style="margin-top:12px">
          <div class="muted2 small">
            Disclaimer: This companion is original educational content and does not reproduce TLPI’s text or figures.
            Always verify details with man pages and your target kernel/libc versions.
          </div>
        </div>
      </main>

      <aside class="righttoc">
        <div class="glass pad">
          <div class="section-title">On this page</div>
          <div id="toc" class="toc"></div>
        </div>
      </aside>
    </div>

    <div class="footer">
      Generated 2026-02-06 20:53 UTC. Appendix B. Static HTML.
    </div>
  </div>

  <script src="../assets/tlpi_nav.js"></script>
  <script src="../assets/widgets.js"></script>
  <script src="../assets/ui.js"></script>
  <script>
    TLPIUI.initChapterPage({kind:"appendix", id:"appB", letter:"B", subtitle:"Appendix B \u2014 Parsing Command-Line Options"});
    TLPIWidgets.mountKernelGraph("kg_appB", {
      title: "Kernel object map (appendix context)",
      subtitle: "Appendices reinforce the same kernel object model; hover nodes and connect concepts across chapters.",
      highlight: ["process", "fdtable", "file", "inode", "vmm", "signal", "socket"]
    });
TLPIWidgets.mountStraceParser("str_appB", {example: "execve(\"./tool\", [\"./tool\", \"-v\", \"--output\", \"out.txt\"], 0x7ffd...) = 0\nopenat(AT_FDCWD, \"out.txt\", O_WRONLY|O_CREAT|O_TRUNC|O_CLOEXEC, 0644) = 3\n"});
  </script>
</body>
</html>
